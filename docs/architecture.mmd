flowchart LR

%% =========================
%% Clients
%% =========================
subgraph Client
  Browser[Browser / Hoppscotch]
end

%% =========================
%% Authentication (Cognito)
%% =========================
subgraph Auth[Cognito]
  HostedUI[Cognito Hosted UI (Domain)]
  UserPool[(User Pool)]
  HostedUI -->|Issues ID/Access JWT| Browser
  UserPool --- HostedUI
end

%% =========================
%% API & Compute
%% =========================
subgraph API[API Layer]
  APIGW[API Gateway (HTTP API)]
  Authorizer[Cognito User Pool Authorizer]
  APIGW --> Authorizer
  Authorizer --> APIGW
end

subgraph Compute[Compute]
  Lambda[Lambda (Python)]
end

%% =========================
%% Data & Events
%% =========================
subgraph DataEvents[Data & Events]
  Dynamo[(DynamoDB Table)]
  Bus[(EventBridge Bus)]
  TargetLogs[CloudWatch Logs Target]
  Bus --> TargetLogs
  Bus -. optional .-> ConsumerB[Future Consumer(s)]
end

%% =========================
%% Observability
%% =========================
subgraph Observability
  APILog[API Gateway Logs]
  LambdaLog[Lambda Logs]
end

%% =========================
%% CI/CD
%% =========================
subgraph CICD[CI/CD]
  GH[GitHub Actions (OIDC)]
  IAMRole[(IAM Deploy Role)]
  TF[Terraform Plan/Apply]
  GH -->|AssumeRoleWithWebIdentity| IAMRole
  IAMRole --> TF
end

%% =========================
%% Request Flow
%% =========================
Browser -->|GET /public| APIGW
Browser -->|POST /items<br/>Authorization: Bearer ID token| APIGW

APIGW -->|Lambda proxy| Lambda
Lambda --> Dynamo
Lambda -->|PutEvents| Bus

%% Logs
APIGW --> APILog
Lambda --> LambdaLog

%% Provisioning (Terraform wires everything)
TF --> APIGW
TF --> Lambda
TF --> Dynamo
TF --> Bus
TF --> UserPool
TF --> HostedUI
TF --> APILog
TF --> LambdaLog
TF --> IAMRole
